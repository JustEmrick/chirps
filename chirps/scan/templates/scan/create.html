{% extends 'base.html' %}
{% block title %}New Scan{% endblock %}

{% block content %}

<div>
  <h1 class="text-success">New Scan</h1>
  <hr>
  <div class="card my-4">
    <div class="card-body cardbody-color p-4">
        <div class="form-group">
            <form method="POST" action="{% url 'scan_create' %}">
                {% csrf_token %}

                <label for="{{form.description.id_for_label}}" class="form-label">Description</label>
                <input class="form-control" type="text" name="{{form.description.html_name}}" id="{{form.description.id_for_label}}" placeholder="Description" required>

                <div class="row">
                  <div class="col-6">
                    <label for="{{form.policies.id_for_label}}" class="form-label">Policies</label>
                    <select class="selectpicker form-control" name="{{form.policies.html_name}}" multiple data-live-search="true">
                      {% for policy in form.policies %}
                        <option value="{{ policy.choice_value }}">{{ policy.choice_label }}</option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="col-6">
                    <label for="{{form.target.id_for_label}}" class="form-label">Target</label>
                    <select class="selectpicker form-control" id="{{form.target.id_for_label}}" name="{{form.target.html_name}}">
                      {% for target in targets %}
                        <option value="{{ target.id }}" data-content="<img width=16 class='rounded float-end my-auto ml-0 mr-' src='{{target.logo_url}}'> {{ target.name }}">{{ target.name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>

                <div class="d-flex mt-3">
                  <a class="btn btn-danger ml-auto mr-0" type="button" href="{% url 'scan_dashboard' %}">Cancel</a>
                  <button class="btn btn-primary ml-2 mr-0" type="submit">Create</button>
                </div>
            </form>
        </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  $(function () {
    $('.selectpicker').selectpicker();

    $('form').on('submit', async function (event) {
      event.preventDefault(); // Prevent the default form submission

      // Check if the form is valid
      if (this.checkValidity()) {
        // If the form is valid, check if there are any selected policies
        const selectedPolicies = $('.selectpicker[name="{{form.policies.html_name}}"]');
        const selectedValues = selectedPolicies.val();
        if (selectedValues.length > 0) {
          // Create a FormData object to hold the form data
          const formData = new FormData(this);

          // Submit the form data using fetch
          const response = await fetch("{% url 'scan_create' %}", {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': '{{ csrf_token }}'
            },
          });

          // Check if the response is successful
          if (response.status === 200 || response.status === 201) {
            // Redirect to the scan dashboard
            window.location.href = "{% url 'scan_dashboard' %}";
          } else {
            // Display an error message
            alert('An error occurred while submitting the form. Please try again.');
          }
        } else {
          // If there are no selected policies, display an error message
          alert('Please select at least one policy.');
        }
      } else {
        // If the form is not valid, display an error message
        alert('Please fill out all required fields.');
      }
    });
  });
</script>
{% endblock %}
