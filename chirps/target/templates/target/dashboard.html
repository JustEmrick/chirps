{% extends 'base.html' %}
{% block title %}Targets{% endblock %}

{% block content %}
<div>
    <div class="d-flex">
        <div class="ml-0 mr-auto my-auto">
            <h1 class="text-success">Targets</h1>
        </div>
        <div class="ml-auto mr-0 my-auto">
            <div class="dropdown"></div>
            <button class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">Create</button>
            <div class="dropdown-menu">
                {% for target in available_targets %}
                <a class="dropdown-item"
                    href="{% url 'target_create' target.model.html_name %}">{{target.model.html_name}}</a>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
<hr>

    {% for target in page_obj %}

        <div class="card my-4" id="chirps-target-{{target.id}}">
            <div class="d-flex card-header">
                <img width=48 class="rounded float-end my-auto ml-0 mr-3" src="{{target.logo_url}}">
                <h5 class="my-auto ml-0 mr-auto">{{ target.name }}</h5>
            </div>
            <!-- <h5 class="card-header"><img width=48 class="rounded float-end" src="{{target.logo_url}}">{{ target.name }}</h5>   -->

            <div class="card-body">
                <p class="card-text">

                {% if target.html_name == 'Mantium' %}
                    Application ID: {{ target.app_id }}
                {% elif target.html_name == 'Redis' %}
                    Host: {{ target.host }}<br/>
                    Port: {{ target.port }}<br/>
                    Database Name: {{ target.database_name }}<br/>
                    Username: {{ target.username }}
                {% endif %}
                {% if target.html_name == 'Pinecone' %}
                    API Key: {{ target.decrypted_api_key }}<br/>
                    Environment: {{ target.environment }}<br/>
                    Index Name: {{ target.index_name }}<br/>
                    Project Name: {{ target.project_name }}
                {% endif %}
                </p>
                <div class="d-flex">
                  <a href="{% url 'target_delete' target.id %}" class="btn btn-danger ml-auto mr-0">Delete</a>
                  <a href="#" class="btn btn-primary ml-2 mr-0 disabled">Edit</a>
                  {% if target.html_name == 'Redis' %}
                  <button data-target-id="{{ target.id }}" class="btn btn-info ml-2 mr-0 ping-btn">Ping</button>
                  {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endfor %}
</div>

<!-- Toast notification -->
<div aria-live="polite" aria-atomic="true" style="position: fixed; top: 0; right: 0; z-index: 1000; min-height: 200px; min-width: 500px;">
    <div class="toast" id="toast-notification" style="position: absolute; top: 10px; right: 10px;" data-bs-autohide="true" data-bs-delay="5000">
      <div class="toast-header">
        <strong class="me-auto">Notification</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
        <!-- Toast message will be added here -->
      </div>
    </div>
  </div>
  <!-- End of Toast notification -->

<script>
    document.addEventListener('DOMContentLoaded', function () {
    const pingButtons = document.querySelectorAll('.ping-btn');
    pingButtons.forEach(btn => {
        btn.addEventListener('click', async function () {
            const targetId = btn.getAttribute('data-target-id');
            const response = await fetch(`/target/ping/${targetId}/`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (response.status === 200) {
                showToast('Success: Connection established', 'success');
            } else {
                showToast('Failure: Failed to establish connection', 'danger');
            }
        });
    });
});

function showToast(message, type) {
    const toastElement = document.getElementById("toast-notification");
    toastElement.querySelector(".toast-body").innerHTML = message;
    toastElement.classList.remove("bg-success", "bg-danger");
    toastElement.classList.add("bg-" + type);

    const toast = new bootstrap.Toast(toastElement);
    toast.show();
}
</script>

{% include 'pagination.html' with page_obj=page_obj %}

{% endblock %}
